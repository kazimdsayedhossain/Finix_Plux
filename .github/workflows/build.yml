name: Finix_Plus Build (Qt6 + CMake)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # 1. Setup MSYS2 and MinGW
      # This provides a working C++ compiler that won't fail the CMake test
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make

      # 2. Install Qt 6.8.1
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.1'
          arch: 'win64_mingw'
          modules: 'qtmultimedia qtshadertools'

      # 3. Configure CMake
      # We explicitly point CMake to the MinGW compiler we installed in step 1
      - name: Configure CMake
        shell: msys2 {0}
        run: |
          mkdir -p build
          cd build
          cmake .. -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="/d/a/Finix_Plus/Qt/6.8.1/mingw_64" \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++

      # 4. Build
      - name: Build
        shell: msys2 {0}
        run: |
          cd build
          mingw32-make -j$(nproc)

      # 5. Deploy Qt runtime
      # We switch back to pwsh for deployment to use Windows-style paths for windeployqt
      - name: Deploy
        shell: pwsh
        run: |
          cd build
          $deployTool = "$env:Qt6_DIR/bin/windeployqt.exe"
          & $deployTool --qmldir ../ --no-translations --compiler-runtime *.exe

      # 6. Upload artifact
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Finix_Plus_Windows_Build
          path: build/
